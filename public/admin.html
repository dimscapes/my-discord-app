<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
        <!-- ===============================================-->
        <!--    Document Title-->
        <!-- ===============================================-->
        <title>Dim's Capes</title>
    
    
        <!-- ===============================================-->
        <!--    Favicons-->
        <!-- ===============================================-->
        <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
        <link rel="manifest" href="/assets/img/favicons/site.webmanifest">
    
        <!-- ===============================================-->
        <!--    Stylesheets-->
        <!-- ===============================================-->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;500;600;700&amp;family=Poppins:ital,wght@0,400;0,500;0,600;0,700;1,300&amp;display=swap" rel="stylesheet">
        <link href="assets/css/theme.css" rel="stylesheet" />
        <link href="assets/css/user.css" rel="stylesheet" />
    
      </head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top py-3" data-navbar-on-scroll="light">
        <div class="container"><a class="navbar-brand" href=""><img src="assets/img/icons/Logo.png" height="35" alt="logo" /></a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
          <div class="collapse navbar-collapse border-top border-lg-0 mt-4 mt-lg-0" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto pt-2 pt-lg-0 font-base align-items-center">
              <li class="nav-item"><a class="nav-link px-3" href="/staff">Home</a></li>
              <li class="nav-item" id="capeToolTab" style="display:none;"><a class="nav-link px-3" href="/cape">Cape Tool</a></li>
              <li class="nav-item" id="moderationTab" style="display:none;"><a class="nav-link px-3" href="/mod">Moderation</a></li>
              <li class="nav-item" id="adminTab" style="display:none;"><a class="nav-link pl-3 me-3" href="/admin">Admin</a></li>
            </ul>
            <button class="btn btn-primary" id="login-button">Log out</button>
            <script>
              document.getElementById('login-button').addEventListener('click', function() {
                  window.location.href = '/logout'; // Redirect to the Discord login route
              });
          </script>
          <script>
            // Fetch user roles from the server
            fetch('/api/user/roles')
              .then(response => response.json())
              .then(data => {
                const roles = data.roles;
          
                // Check if the user has the "Cape Team" or "Administration" role
                if (roles.includes('Cape Team') || roles.includes('Administration')) {
                  document.getElementById('capeToolTab').style.display = 'block';  // Show the "Cape Tool" tab
                }
              })
              .catch(error => console.error('Error fetching roles:', error));
          </script>
          <script>
            // Fetch user roles from the server
            fetch('/api/user/roles')
              .then(response => response.json())
              .then(data => {
                const roles = data.roles;
          
                // Check if the user has the "Cape Team" or "Administration" role
                if (roles.includes('Moderation') || roles.includes('Administration')) {
                  document.getElementById('moderationTab').style.display = 'block';  // Show the "Cape Tool" tab
                }
              })
              .catch(error => console.error('Error fetching roles:', error));
          </script>
          <script>
            // Fetch user roles from the server
            fetch('/api/user/roles')
              .then(response => response.json())
              .then(data => {
                const roles = data.roles;
          
                // Check if the user has the "Cape Team" or "Administration" role
                if (roles.includes('Administration')) {
                  document.getElementById('adminTab').style.display = 'block';  // Show the "Cape Tool" tab
                }
              })
              .catch(error => console.error('Error fetching roles:', error));
          </script>
          </div>
        </div>
      </nav>
      <section class="py-7 py-lg-5" id="home">
      <div class="bg-holder bg-size" style="background-image:url(assets/img/illustration/2.png);background-position:left top;background-size:contain;">
    </div></section>
    <div class="container mt-5">
        <h1 class="mb-4">Admin Dashboard</h1>
        
        <!-- Add New User Form -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>Add / Update User</h4>
                <form id="userForm">
                    <div class="mb-3">
                        <label for="userNickname" class="form-label">Nickname</label>
                        <input type="text" id="userNickname" class="form-control" placeholder="Enter User Nickname" required>
                    </div>                    
                    <div class="mb-3">
                        <label for="userId" class="form-label">Discord User ID</label>
                        <input type="text" id="userId" class="form-control" placeholder="Enter Discord User ID" required>
                    </div>
                    <div class="mb-3">
                        <label for="userRoles" class="form-label">Roles</label>
                        <select id="userRoles" class="form-select" multiple required></select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add / Update User</button>
                </form>
            </div>
        </div>

        <!-- Users Table -->
        <div class="card">
            <div class="card-body">
                <h4>Manage Users</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Nickname</th>
                            <th>User ID</th>
                            <th>Roles</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be populated here -->
                    </tbody>                    
                </table>
            </div>
        </div>
    </div>

    <script>
        // Fetch and populate roles in the select menu
        function fetchRoles() {
            fetch('/api/admin/roles')
                .then(response => response.json())
                .then(roles => {
                    const select = document.getElementById('userRoles');
                    select.innerHTML = '';
                    roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role;
                        option.textContent = role;
                        select.appendChild(option);
                    });
                });
        }

        // Fetch users and populate the table
        function fetchUsers() {
            fetch('/api/admin/users')
                .then(response => response.json())
                .then(users => {
                    const tbody = document.getElementById('usersTableBody');
                    tbody.innerHTML = '';
                    for (const userId in users) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${users[userId].nickname || 'No nickname'}</td>  <!-- Display nickname -->
                            <td>${userId}</td>
                            <td>${users[userId].roles.join(', ')}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser('${userId}')">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                });
        }

        // Add or update user
        document.getElementById('userForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const userId = document.getElementById('userId').value;
            const nickname = document.getElementById('userNickname').value;  // Get nickname
            const roles = Array.from(document.getElementById('userRoles').selectedOptions).map(option => option.value);

            fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, roles, nickname })  // Send nickname along with userId and roles
            }).then(response => response.json()).then(data => {
                alert(data.message);
                fetchUsers();
            });
        });


        // Delete user
        function deleteUser(userId) {
            fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE',
            }).then(response => response.json()).then(data => {
                alert(data.message);
                fetchUsers();
            });
        }

        // Initial fetching of roles and users
        fetchRoles();
        fetchUsers();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
